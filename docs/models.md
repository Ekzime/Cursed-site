# Cursed Board - Database Models

## Overview

The Cursed Board backend uses SQLAlchemy 2.0 with async support to model a traditional imageboard structure (users, boards, threads, posts) with additional fields for anomaly tracking and curse mechanics.

All models inherit from `Base` (SQLAlchemy `DeclarativeBase`) and use MySQL as the backend database via the `asyncmy` driver.

## Entity Relationship Diagram

```
┌─────────────────────┐
│       User          │
│─────────────────────│
│ id (PK)             │
│ username (unique)   │
│ email (unique)      │
│ hashed_password     │
│ avatar_url          │
│ created_at          │
│ is_anomaly          │◄────────┐ (NPC users for anomalies)
│ anomaly_data (JSON) │         │
└──────────┬──────────┘         │
           │                    │
           │ 1:N                │
           │                    │
┌──────────▼──────────┐         │
│       Post          │         │
│─────────────────────│         │
│ id (PK)             │         │
│ thread_id (FK)      ├─────┐   │
│ user_id (FK)        │     │   │
│ content             │     │   │
│ created_at          │     │   │
│ updated_at          │     │   │
│ is_anomaly          │─────┼───┘ (anomalous posts)
│ anomaly_type        │     │
└──────────┬──────────┘     │
           │                │
           │ 1:N            │ N:1
           │                │
┌──────────▼──────────┐     │   ┌─────────────────────┐
│      Media          │     └──►│      Thread         │
│─────────────────────│         │─────────────────────│
│ id (PK)             │         │ id (PK)             │
│ post_id (FK)        │         │ board_id (FK)       ├─────┐
│ type                │         │ title               │     │
│ url                 │         │ created_at          │     │
│ filename            │         │ updated_at          │     │ N:1
│ corruption_level    │         │ is_sticky           │     │
│ created_at          │         │ is_locked           │     │
└─────────────────────┘         │ anomaly_level       │     │
                                └─────────────────────┘     │
                                                            │
                                    ┌───────────────────────▼─┐
                                    │       Board             │
                                    │─────────────────────────│
                                    │ id (PK)                 │
                                    │ slug (unique)           │
                                    │ name                    │
                                    │ description             │
                                    │ is_hidden               │
                                    │ unlock_trigger          │
                                    │ created_at              │
                                    └─────────────────────────┘
```

## Model Definitions

### User Model

**File:** `/home/ekz/Documents/Projects/cursed-board/backend/app/models/user.py`

**Purpose:** Represents both real registered users and NPC/anomaly users generated by the Ritual Engine.

```python
class User(Base):
    __tablename__ = "users"

    # Primary Key
    id: Mapped[int]                           # Auto-increment primary key

    # Core Fields
    username: Mapped[str]                     # Unique, max 50 chars, indexed
    email: Mapped[str]                        # Unique, max 255 chars, indexed
    hashed_password: Mapped[str]              # bcrypt hash, max 255 chars
    avatar_url: Mapped[Optional[str]]         # URL to avatar image, nullable
    created_at: Mapped[datetime]              # Auto-set on creation

    # Anomaly Fields (for NPC users)
    is_anomaly: Mapped[bool]                  # True for AI/NPC generated users
    anomaly_data: Mapped[Optional[dict]]      # JSON metadata for anomaly behavior

    # Relationships
    posts: Mapped[List["Post"]]               # One user has many posts
```

**Key Features:**

- **Authentication:** Passwords hashed with bcrypt via Passlib
- **Indexing:** `username` and `email` are indexed for fast lookups
- **Anomaly Support:** NPC users can be flagged with `is_anomaly=True`
  - `anomaly_data` stores generation params (e.g., personality, trigger conditions)
- **Constraints:**
  - `username` and `email` must be unique
  - `username` max length: 50 characters
  - `email` max length: 255 characters

**Example Anomaly User:**
```json
{
  "username": "USER_74291",
  "email": "ghost@cursed.local",
  "is_anomaly": true,
  "anomaly_data": {
    "personality": "cryptic",
    "trigger": "thread_666_views",
    "post_count": 3
  }
}
```

### Board Model

**File:** `/home/ekz/Documents/Projects/cursed-board/backend/app/models/board.py`

**Purpose:** Represents forum boards (categories). Supports hidden boards that unlock based on user behavior.

```python
class Board(Base):
    __tablename__ = "boards"

    # Primary Key
    id: Mapped[int]                           # Auto-increment primary key

    # Core Fields
    slug: Mapped[str]                         # URL-friendly identifier (e.g., "general")
    name: Mapped[str]                         # Display name (e.g., "General Discussion")
    description: Mapped[Optional[str]]        # Text description, nullable
    created_at: Mapped[datetime]              # Auto-set on creation

    # Visibility Fields
    is_hidden: Mapped[bool]                   # If true, board is hidden until unlocked
    unlock_trigger: Mapped[Optional[str]]     # Trigger condition for unlocking

    # Relationships
    threads: Mapped[List["Thread"]]           # One board has many threads
```

**Key Features:**

- **Slug:** Unique identifier for URLs (e.g., `/boards/paranormal`)
- **Hidden Boards:**
  - `is_hidden=True` boards don't appear in listings by default
  - `unlock_trigger` specifies condition (e.g., `"progress>=50"`, `"trigger:midnight_visit"`)
- **Constraints:**
  - `slug` must be unique and indexed
  - `slug` max length: 50 characters
  - `name` max length: 100 characters

**Example Hidden Board:**
```json
{
  "slug": "the-underneath",
  "name": "The Underneath",
  "description": "You shouldn't be here.",
  "is_hidden": true,
  "unlock_trigger": "progress>=75"
}
```

### Thread Model

**File:** `/home/ekz/Documents/Projects/cursed-board/backend/app/models/thread.py`

**Purpose:** Represents discussion threads within boards. Tracks anomaly intensity per thread.

```python
class Thread(Base):
    __tablename__ = "threads"

    # Primary Key
    id: Mapped[int]                           # Auto-increment primary key

    # Foreign Keys
    board_id: Mapped[int]                     # FK to boards.id, indexed

    # Core Fields
    title: Mapped[str]                        # Thread title, max 255 chars
    created_at: Mapped[datetime]              # Auto-set on creation
    updated_at: Mapped[datetime]              # Auto-updated on modification

    # Moderation Fields
    is_sticky: Mapped[bool]                   # Pinned to top of board
    is_locked: Mapped[bool]                   # No new posts allowed

    # Anomaly Fields
    anomaly_level: Mapped[int]                # 0-10 scale of thread "cursedness"

    # Relationships
    board: Mapped["Board"]                    # Many threads belong to one board
    posts: Mapped[List["Post"]]               # One thread has many posts (ordered by created_at)
```

**Key Features:**

- **Anomaly Level:** 0 (normal) to 10 (maximum cursedness)
  - Higher levels increase mutation probability
  - Can be set manually or calculated based on user progress
- **Timestamps:**
  - `created_at`: Never changes
  - `updated_at`: Auto-updates on thread modification (e.g., new post added)
- **Moderation:**
  - `is_sticky`: Thread appears at top of board listing
  - `is_locked`: Prevents new posts (archived thread)
- **Ordering:** Posts relationship ordered by `Post.created_at` ascending

**Anomaly Level Examples:**
- `0-2`: Normal thread, minimal mutations
- `3-5`: Occasional typos, character substitutions
- `6-8`: Heavy glitching, zalgo text, missing words
- `9-10`: Maximum corruption, nonsensical output

### Post Model

**File:** `/home/ekz/Documents/Projects/cursed-board/backend/app/models/post.py`

**Purpose:** Individual posts within threads. Can be flagged as anomalies (AI-generated or cursed).

```python
class Post(Base):
    __tablename__ = "posts"

    # Primary Key
    id: Mapped[int]                           # Auto-increment primary key

    # Foreign Keys
    thread_id: Mapped[int]                    # FK to threads.id, indexed
    user_id: Mapped[int]                      # FK to users.id, indexed

    # Core Fields
    content: Mapped[str]                      # Post text (markdown/plaintext)
    created_at: Mapped[datetime]              # Auto-set on creation
    updated_at: Mapped[datetime]              # Auto-updated on edit

    # Anomaly Fields
    is_anomaly: Mapped[bool]                  # True for AI-generated or cursed posts
    anomaly_type: Mapped[Optional[str]]       # Type of anomaly (e.g., "npc_reply", "echo")

    # Relationships
    thread: Mapped["Thread"]                  # Many posts belong to one thread
    user: Mapped["User"]                      # Many posts belong to one user
    media: Mapped[List["Media"]]              # One post can have multiple media attachments
```

**Key Features:**

- **Content Mutation:** Applied at response time, not stored
  - Raw content stored in database
  - `ContentMutator` applies transformations based on `RitualState.progress`
- **Anomaly Types:**
  - `"npc_reply"`: Generated by NPC user
  - `"echo"`: Repeats user's own previous post
  - `"glitch"`: Intentionally corrupted content
  - `"prophecy"`: References future events
- **Media Attachments:** One-to-many relationship with `Media` model
- **Indexing:** Both `thread_id` and `user_id` indexed for fast queries

**Example Anomalous Post:**
```json
{
  "user_id": 99,  // NPC user
  "thread_id": 42,
  "content": "I remember when you posted this. Before you posted this.",
  "is_anomaly": true,
  "anomaly_type": "prophecy"
}
```

### Media Model

**File:** `/home/ekz/Documents/Projects/cursed-board/backend/app/models/media.py`

**Purpose:** Media attachments for posts (images, videos, files). Supports corruption effects.

```python
class Media(Base):
    __tablename__ = "media"

    # Primary Key
    id: Mapped[int]                           # Auto-increment primary key

    # Foreign Keys
    post_id: Mapped[int]                      # FK to posts.id, indexed

    # Core Fields
    type: Mapped[str]                         # "image", "video", "file"
    url: Mapped[str]                          # URL to media resource
    filename: Mapped[str]                     # Original filename
    created_at: Mapped[datetime]              # Upload timestamp

    # Anomaly Fields
    corruption_level: Mapped[int]             # 0-10 scale of visual corruption

    # Relationships
    post: Mapped["Post"]                      # Many media belong to one post
```

**Key Features:**

- **Media Types:**
  - `"image"`: PNG, JPG, GIF, WebP
  - `"video"`: MP4, WebM
  - `"file"`: Other attachments (PDF, TXT, etc.)
- **Corruption Level:** 0 (pristine) to 10 (maximum corruption)
  - Frontend applies visual filters based on level
  - Examples: static overlay, color shift, pixelation, datamoshing
- **Storage:** URLs point to external storage (S3, CDN, or local `/media/`)
- **Max Lengths:**
  - `type`: 20 characters
  - `url`: 500 characters
  - `filename`: 255 characters

**Corruption Examples:**
- `0`: Original image
- `3`: Slight color distortion
- `6`: Heavy static/noise overlay
- `10`: Nearly unrecognizable, severe artifacts

## Relationships Summary

```
User ──1:N──> Post ──N:1──> Thread ──N:1──> Board
                │
                └──1:N──> Media
```

### Cascading Behavior

- **Board deletion:** Can be set to cascade to threads (not yet implemented)
- **Thread deletion:** Should cascade to posts (not yet implemented)
- **Post deletion:** Should cascade to media (not yet implemented)
- **User deletion:** Posts remain but can be orphaned or reassigned to `[deleted]` user

## Indexes

All foreign keys are automatically indexed:

- `users.username` (unique index)
- `users.email` (unique index)
- `boards.slug` (unique index)
- `threads.board_id` (foreign key index)
- `posts.thread_id` (foreign key index)
- `posts.user_id` (foreign key index)
- `media.post_id` (foreign key index)

## Common Query Patterns

### Get all threads in a board with post counts

```python
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload

stmt = (
    select(Thread)
    .where(Thread.board_id == board_id)
    .options(selectinload(Thread.posts))
    .order_by(Thread.is_sticky.desc(), Thread.updated_at.desc())
)
result = await db.execute(stmt)
threads = result.scalars().all()
```

### Get posts with user and media

```python
stmt = (
    select(Post)
    .where(Post.thread_id == thread_id)
    .options(
        selectinload(Post.user),
        selectinload(Post.media)
    )
    .order_by(Post.created_at.asc())
)
result = await db.execute(stmt)
posts = result.scalars().all()
```

### Find unlockable boards for user

```python
# In application logic (not SQL)
state = await ritual_state_manager.get(user_id)
unlocked_boards = [
    board for board in all_boards
    if not board.is_hidden or check_unlock_condition(board.unlock_trigger, state)
]
```

## Data Constraints

### Character Limits

| Field               | Max Length | Notes                          |
|---------------------|------------|--------------------------------|
| User.username       | 50         | Alphanumeric + underscore      |
| User.email          | 255        | Standard email format          |
| User.hashed_password| 255        | bcrypt hash                    |
| User.avatar_url     | 500        | Full URL                       |
| Board.slug          | 50         | Lowercase, hyphens allowed     |
| Board.name          | 100        | Display name                   |
| Thread.title        | 255        | Plain text                     |
| Post.anomaly_type   | 50         | Enum-like string               |
| Media.type          | 20         | "image", "video", "file"       |
| Media.url           | 500        | Full URL                       |
| Media.filename      | 255        | Original filename              |

### Numeric Ranges

| Field                 | Min | Max | Default |
|-----------------------|-----|-----|---------|
| Thread.anomaly_level  | 0   | 10  | 0       |
| Media.corruption_level| 0   | 10  | 0       |

## Schema Evolution

### Planned Migrations

Future additions to support advanced features:

**Thread Model:**
- `last_post_at` - Denormalized timestamp for sorting
- `post_count` - Denormalized count for display
- `view_count` - Track thread popularity

**Post Model:**
- `reply_to_id` - FK to posts.id for threaded replies
- `is_edited` - Flag for edited posts
- `edit_history` - JSON array of previous versions

**User Model:**
- `last_login` - Track activity
- `role` - Enum: "user", "moderator", "admin"
- `is_banned` - Moderation flag

**New Table: BoardVisibility**
- `user_id` (FK to users.id)
- `board_id` (FK to boards.id)
- `unlocked_at` - Timestamp of unlock
- Track per-user board unlocks (instead of session-based)

## Type Hints

All models use SQLAlchemy 2.0 `Mapped[]` type hints:

```python
from sqlalchemy.orm import Mapped

# Required field (NOT NULL)
username: Mapped[str]

# Optional field (NULL allowed)
avatar_url: Mapped[Optional[str]]

# Relationship (one-to-many)
posts: Mapped[List["Post"]]

# Relationship (many-to-one)
user: Mapped["User"]
```

## Database Creation

Models are automatically created on application startup:

```python
# In main.py lifespan
async with engine.begin() as conn:
    await conn.run_sync(Base.metadata.create_all)
```

For production, use Alembic migrations instead of `create_all()`.
