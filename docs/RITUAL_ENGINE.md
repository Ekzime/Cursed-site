# Ritual Engine - Система Проклятий

## Обзор

Ritual Engine — это система, которая отслеживает поведение пользователя и генерирует "проклятия" (аномалии) на основе его активности. Чем дольше пользователь на сайте, тем больше странных вещей происходит.

## Компоненты

```
┌─────────────────────────────────────────────────────────────┐
│                      RitualEngine                           │
│  (Главный оркестратор)                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ RitualState │  │  Triggers   │  │  ProgressEngine     │ │
│  │  Manager    │  │  Checker    │  │                     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │  Anomaly    │  │  Anomaly    │  │  Content            │ │
│  │  Generator  │  │  Queue      │  │  Mutator            │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Уровни прогресса

| Уровень | Диапазон | Частота аномалий | Описание |
|---------|----------|------------------|----------|
| LOW | 0-20% | Редко (2%) | Всё кажется нормальным |
| MEDIUM | 21-50% | Иногда (8%) | Что-то здесь не так |
| HIGH | 51-80% | Часто (20%) | Они знают, что ты здесь |
| CRITICAL | 81-100% | Постоянно (40%) | Ты один из нас теперь |

## Триггеры

Триггеры активируются на основе поведения пользователя:

### Визиты
| Триггер | Условие | Эффект |
|---------|---------|--------|
| `first_visit` | Первый визит (progress=0) | +5 прогресса |
| `returnee` | Вернулся через 7+ дней | +10 прогресса, ×1.3 аномалий |
| `frequent_visitor` | 5+ визитов в неделю | +15 прогресса |

### Чтение
| Триггер | Условие | Эффект |
|---------|---------|--------|
| `deep_reader` | 20+ просмотренных постов | +10 прогресса |
| `speed_reader` | >5 постов/минуту | -5 прогресса (наказание) |
| `slow_reader` | >60 сек на пост | +5 прогресса |
| `obsessive` | >50% повторных просмотров | +15 прогресса |

### Время
| Триггер | Условие | Эффект |
|---------|---------|--------|
| `late_night` | 22:00-05:59 | +5 прогресса, ×1.5 аномалий |
| `witching_hour` | 02:00-04:59 | +10 прогресса, ×2.5 аномалий |
| `too_long` | 1+ час на сайте | +15 прогресса |
| `marathon` | 3+ часа на сайте | +25 прогресса |

### Прогресс
| Триггер | Условие | Эффект |
|---------|---------|--------|
| `halfway` | progress >= 50 | Сообщение: "Назад дороги нет" |
| `almost_there` | progress >= 80 | ×2.0 аномалий |
| `enlightened` | progress >= 100 | Открывает скрытую доску |

## Типы аномалий

### Визуальные
- `glitch` — RGB смещение, шум
- `flicker` — мерцание экрана
- `static` — статика поверх контента

### Присутствие
- `presence` — "Кто-то смотрит на тебя"
- `shadow` — движение теней
- `eyes` — появляются глаза

### Контент
- `new_post` — появляется фейковый пост
- `post_edit` — текст поста меняется
- `post_corrupt` — текст искажается

### Аудио (для фронтенда)
- `whisper` — шёпот с сообщением
- `heartbeat` — звук сердцебиения
- `ambient` — изменение фона

### UI
- `notification` — фейковое уведомление
- `cursor` — курсор ведёт себя странно
- `typing` — текст печатается сам

## Content Mutations

Мутации текста применяются на основе прогресса:

### Glitch (символы █▒▓)
```
До:  "Привет, как дела?"
После: "П░и▒ет, ка█ дела?"
```

### Zalgo (диакритики)
```
До:  "Они здесь"
После: "О̷н̸и̵ ̶з̷д̵е̸с̷ь̶"
```

### Redaction (█████)
```
До:  "Секретная информация скрыта"
После: "████████ информация ██████"
```

### Insertion (вставки)
```
До:  "Обычный текст поста"
После: "Обычный НЕ ОГЛЯДЫВАЙСЯ текст поста"
```

## WebSocket API

### Подключение
```javascript
const ws = new WebSocket('ws://host/ws/ritual?fp=fingerprint');
```

### Получение аномалий
```json
{
  "type": "anomaly",
  "payload": {
    "id": "uuid",
    "anomaly_type": "whisper",
    "severity": "moderate",
    "target": "user",
    "data": {"message": "...ты слышишь нас?..."},
    "duration_ms": 5000
  }
}
```

### Отправка активности
```json
{
  "type": "activity",
  "data": {
    "time_spent": 60,
    "viewed_thread": 123
  }
}
```

## Admin API

```bash
# Получить состояние пользователя
GET /admin/ritual/state/{user_id}

# Установить прогресс
POST /admin/ritual/state/{user_id}/progress
{"progress": 50}

# Триггернуть аномалию
POST /admin/ritual/anomaly/{user_id}
{"anomaly_type": "whisper"}

# Broadcast всем
POST /admin/ritual/broadcast
{"anomaly_type": "glitch"}
```

## Конфигурация

```env
# TTL состояния в Redis (24 часа)
RITUAL_STATE_TTL=86400

# Имя cookie для идентификации
RITUAL_COOKIE_NAME=ritual_id

# Header для fingerprint
RITUAL_FINGERPRINT_HEADER=X-Fingerprint
```
